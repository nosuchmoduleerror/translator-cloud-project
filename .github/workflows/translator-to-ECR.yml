name: "Deploy translator docker to ECR"

on:
  push:
    branches:
    - master
    paths: 
      src/translate/**

jobs:
  # Create and push to ECR an artifact of the translator-container generated by a Dockerfile
  docker-container:
    name: Environment set-up
    runs-on: ubuntu-latest
    environment: Production

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest argostranslate argparse
        python3 install-language-models.py -f en -t it -txt "Hello World"
        python3 install-language-models.py -f it -t en -txt "Ciao Mondo"
        pytest ./test_translate.py
      working-directory: .github/workflows/tests/
    
    - name: Build Docker image
      id: build-translator-image
      run: |
        docker build -t translator-repository .
        docker save translator-repository > /tmp/translator-repository.tar
      working-directory: ./scripts/docker-files/translate/

    - name: Upload image artifact in a tmp file
      uses: actions/upload-artifact@v3
      with:
        name: translator-repository
        path: /tmp/translator-repository.tar
        
    #Push translator on AWS ECR
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Login to Amazon ECR
      id: ecr-login
      uses: aws-actions/amazon-ecr-login@v1

    - name: Download image artifact
      uses: actions/download-artifact@v3
      with:
        name: translator-repository
        path: /tmp

    - name: Load Docker image
      run: |
        docker load --input /tmp/translator-repository.tar

    - name: Push image to Amazon ECR
      id: push-image
      env:
        ECR_REGISTRY: 483451515855.dkr.ecr.us-east-1.amazonaws.com
      run: |
        docker tag translator-repository:latest ${ECR_REGISTRY}/translator-repository:latest
        docker push ${ECR_REGISTRY}/translator-repository:latest
        echo "::set-output name=image::${ECR_REGISTRY}/translator-repository:latest"



        
  
      
